/* ════════════════════════════════════════════════════════════
   THAQVA MASJID — translator.js
   Language Switching: English ↔ Malayalam
   Standalone module — does NOT modify any existing code.
════════════════════════════════════════════════════════════ */

(function () {
  "use strict";

  /* ── Translation Strings ─────────────────────────────────── */
  const TRANSLATIONS = {
    en: {
      /* Navbar */
      "nav-home": "Home",
      "nav-about": "About",
      "nav-countdown": "Live Countdown",
      "nav-prayer": "Prayer Times",
      "nav-location": "Location",

      /* Hero */
      "hero-subtitle":
        "A sanctuary of peace, devotion, and community.<br>Welcome all who seek guidance and tranquility.",
      "hero-cta": "View Prayer Times",

      /* About */
      "about-badge": "Our Story",
      "about-title": "About Thaqva Masjid",
      "about-subtitle":
        "Thaqva Masjid stands as a beacon of faith and unity in our community — a place where hearts gather in remembrance of Allah, knowledge is cherished, and every soul finds welcome.",
      "about-mission-h": "Our Mission",
      "about-mission-p":
        "To nurture a thriving Muslim community grounded in authentic Islamic values — through worship, learning, and sincere service to humanity.",
      "about-community-h": "Community Role",
      "about-community-p":
        "We serve as the spiritual heart of the neighbourhood, providing religious guidance, educational programs, and a safe space for all to grow in faith and character.",
      "about-welfare-h": "Welfare & Support",
      "about-welfare-p":
        "We are committed to uplifting those in need — through Zakat distribution, food drives, and compassionate care for widows, orphans, and struggling families in our community.",
      "card-prayers-h": "Daily Prayers",
      "card-prayers-p":
        "Five daily congregational prayers held in an atmosphere of serenity and devotion.",
      "card-classes-h": "Religious Classes",
      "card-classes-p":
        "Qur'an recitation, Tajweed, Islamic studies and Arabic language programs for all ages.",
      "card-gatherings-h": "Community Gatherings",
      "card-gatherings-p":
        "Regular events, Jumu'ah khutbahs, and community iftars strengthening our bonds.",

      /* Countdown */
      "cd-badge": "Live",
      "cd-title": "Next Prayer Countdown",
      "cd-subtitle": "Real-time countdown to your next Salah",
      "cd-label": "Time Remaining",
      "unit-h": "h",
      "unit-m": "m",
      "unit-s": "s",

      /* Prayer Times */
      "pt-badge": "Schedule",
      "pt-title": "Daily Prayer Times",
      "location-title": "Our Location",
      "th-prayer": "Prayer",
      "th-time": "Time",
      "pt-source":
        "Prayer times provided by <strong>azantimes.in</strong> for Kozhikode North Assembly Constituency",

      /* Footer */
      "footer-message":
        '"And establish prayer and give zakah and bow with those who bow [in worship and obedience]." <em>— Quran 2:43</em>',

      /* Prayer names (used for dynamic table / strip / countdown) */
      Fajr: "Fajr",
      Sunrise: "Sunrise",
      Dhuhr: "Dhuhr",
      Asr: "Asr",
      Maghrib: "Maghrib",
      Isha: "Isha",
    },

    ml: {
      /* Navbar */
      "nav-home": "ഹോം",
      "nav-about": "ഞങ്ങളെക്കുറിച്ച്",
      "nav-countdown": "തത്സമയ കൗണ്ട്ഡൗൺ",
      "nav-prayer": "നമസ്കാര സമയം",
      "nav-location": "സ്ഥാനം",

      /* Hero */
      "hero-subtitle":
        "സമാധാനത്തിന്റെയും ഭക്തിയുടെയും സമൂഹത്തിന്റെയും ആശ്രയം.<br>മാർഗദർശനവും ശാന്തിയും തേടുന്ന എല്ലാവർക്കും സ്വാഗതം.",
      "hero-cta": "നമസ്കാര സമയം കാണുക",

      /* About */
      "about-badge": "ഞങ്ങളുടെ കഥ",
      "about-title": "തഖ്‌വ മസ്ജിദിനെക്കുറിച്ച്",
      "about-subtitle":
        "തഖ്‌വ മസ്ജിദ് ഞങ്ങളുടെ സമൂഹത്തിൽ വിശ്വാസത്തിന്റെയും ഐക്യത്തിന്റെയും ദീപസ്തംഭമായി നിലകൊള്ളുന്നു — അല്ലാഹുവിനെ അനുസ്മരിക്കാൻ ഹൃദയങ്ങൾ ഒരുമിക്കുന്ന, അറിവ് വിലമതിക്കുന്ന, എല്ലാ ആത്മാക്കൾക്കും സ്വാഗതം ലഭിക്കുന്ന സ്ഥലം.",
      "about-mission-h": "ഞങ്ങളുടെ ദൗത്യം",
      "about-mission-p":
        "ആരാധന, പഠനം, മനുഷ്യരാശിക്കുള്ള ആത്മാർഥ സേവനം എന്നിവയിലൂടെ — ആധികാരിക ഇസ്ലാമിക മൂല്യങ്ങളിൽ അടിഉറച്ച ഒരു തഴച്ചുവളരുന്ന മുസ്ലിം സമൂഹത്തെ പോഷിപ്പിക്കുക.",
      "about-community-h": "സമൂഹ പങ്ക്",
      "about-community-p":
        "ഞങ്ങൾ നാഭൂതലത്തിന്റെ ആത്മീയ ഹൃദയമായി സേവിക്കുന്നു — മതപരമായ മാർഗദർശനം, വിദ്യാഭ്യാസ പരിപാടികൾ, വിശ്വാസത്തിലും സ്വഭാവത്തിലും വളരാൻ ഏവർക്കും സുരക്ഷിത ഇടം ഒരുക്കുന്നു.",
      "about-welfare-h": "ക്ഷേമവും പിന്തുണയും",
      "about-welfare-p":
        "ആവശ്യത്തിലുള്ളവരെ ഉയർത്തുന്നതിൽ ഞങ്ങൾ പ്രതിജ്ഞാബദ്ധരാണ് — സകാത്ത് വിതരണം, ഭക്ഷ്യ ശേഖരണം, വിധവകൾക്കും അനാഥർക്കും ബുദ്ധിമുട്ടുന്ന കുടുംബങ്ങൾക്കും ദയാലുവായ സേവനം.",
      "card-prayers-h": "ദൈനംദിന നമസ്കാരം",
      "card-prayers-p":
        "ശാന്തിയുടെയും ഭക്തിയുടെയും അന്തരീക്ഷത്തിൽ നടക്കുന്ന അഞ്ച് ദൈനംദിന ജമാഅത്ത് നമസ്കാരങ്ങൾ.",
      "card-classes-h": "മതപഠന ക്ലാസുകൾ",
      "card-classes-p":
        "എല്ലാ പ്രായക്കാർക്കുമായി ഖുർആൻ പാരായണം, തജ്‌വീദ്, ഇസ്ലാമിക പഠനം, അറബി ഭാഷാ പരിപാടികൾ.",
      "card-gatherings-h": "സാമൂഹിക സമ്മേളനങ്ങൾ",
      "card-gatherings-p":
        "ഞങ്ങളുടെ ബന്ധം ശക്തിപ്പെടുത്തുന്ന പതിവ് പരിപാടികൾ, ജുമുഅ ഖുത്ബകൾ, സമൂഹ ഇഫ്താർ.",

      /* Countdown */
      "cd-badge": "തത്സമയം",
      "cd-title": "അടുത്ത നമസ്കാര കൗണ്ട്ഡൗൺ",
      "cd-subtitle": "അടുത്ത നമസ്കാരത്തിലേക്കുള്ള തത്സമയ കൗണ്ട്ഡൗൺ",
      "cd-label": "ശേഷിക്കുന്ന സമയം",
      "unit-h": "മ.മ",
      "unit-m": "മി",
      "unit-s": "സെ",

      /* Prayer Times */
      "pt-badge": "ഷെഡ്യൂൾ",
      "pt-title": "ദൈനംദിന നമസ്കാര സമയം",
      "location-title": "ഞങ്ങളുടെ സ്ഥാനം",
      "th-prayer": "നമസ്കാരം",
      "th-time": "സമയം",
      "pt-source":
        "കോഴിക്കോട് നോർത്ത് അസംബ്ലി മണ്ഡലത്തിനായി <strong>azantimes.in</strong> നൽകുന്ന നമസ്കാര സമയങ്ങൾ",

      /* Footer */
      "footer-message":
        '"നിങ്ങൾ നമസ്കരിക്കുകയും സകാത്ത് നൽകുകയും നമസ്കരിക്കുന്നവരോടൊപ്പം നമസ്കരിക്കുകയും ചെയ്യുക." <em>— ഖുർആൻ 2:43</em>',

      /* Prayer names (dynamic elements) */
      Fajr: "ഫജ്ർ",
      Sunrise: "സൂര്യോദയം",
      Dhuhr: "ദുഹ്ർ",
      Asr: "അസ്ർ",
      Maghrib: "മഗ്‌രിബ്",
      Isha: "ഇശ",
    },
  };

  /* ── State ────────────────────────────────────────────────── */
  let currentLang = "en";

  /* ── Translation Helper ───────────────────────────────────── */
  function t(key) {
    return (
      (TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang][key]) ||
      (TRANSLATIONS["en"] && TRANSLATIONS["en"][key]) ||
      key
    );
  }

  /* ── Apply All Static Translations ────────────────────────── */
  function applyStatic() {
    // Plain text elements
    document.querySelectorAll("[data-i18n]").forEach((el) => {
      el.textContent = t(el.getAttribute("data-i18n"));
    });
    // HTML elements (contain tags like <br>, <strong>, <em>)
    document.querySelectorAll("[data-i18n-html]").forEach((el) => {
      el.innerHTML = t(el.getAttribute("data-i18n-html"));
    });
  }

  /* ── Translate a Prayer Name ───────────────────────────────── */
  function translatePrayer(enName) {
    return t(enName) || enName;
  }

  /* ── Apply Dynamic Prayer Translations ────────────────────── */
  function applyDynamic() {
    // Prayer table rows — first cell holds the prayer name
    document.querySelectorAll("#prayer-tbody tr").forEach((row) => {
      const td = row.querySelector("td:first-child");
      if (!td) return;
      const en = td.getAttribute("data-en");
      if (!en) return;
      // Preserve any text nodes (the ::before dot is CSS, not a text node)
      Array.from(td.childNodes).forEach((node) => {
        if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
          node.textContent = translatePrayer(en);
        }
      });
    });

    // Prayer strip labels
    document.querySelectorAll("#prayer-strip .strip-name").forEach((el) => {
      const en = el.getAttribute("data-en");
      if (en) el.textContent = translatePrayer(en);
    });

    // Countdown prayer name
    const cdName = document.getElementById("cd-prayer-name");
    if (cdName) {
      const en = cdName.getAttribute("data-en");
      if (en) cdName.textContent = translatePrayer(en);
    }
  }

  /* ── Full Language Switch ──────────────────────────────────── */
  function applyLanguage(lang) {
    if (!TRANSLATIONS[lang]) return;
    currentLang = lang;
    document.documentElement.lang = lang;
    applyStatic();
    applyDynamic();
    try {
      localStorage.setItem("thaqva-lang", lang);
    } catch (e) {}
  }

  /* ── MutationObservers: tag dynamic content when it's rendered ─ */
  function setupObservers() {
    // Prayer table — script.js populates this after API fetch
    const tbody = document.getElementById("prayer-tbody");
    if (tbody) {
      new MutationObserver(() => {
        tbody.querySelectorAll("tr").forEach((row) => {
          const td = row.querySelector("td:first-child");
          if (td && !td.hasAttribute("data-en")) {
            td.setAttribute("data-en", td.textContent.trim());
          }
        });
        if (currentLang !== "en") applyDynamic();
      }).observe(tbody, { childList: true });
    }

    // Prayer strip — script.js populates this after API fetch
    const strip = document.getElementById("prayer-strip");
    if (strip) {
      new MutationObserver(() => {
        strip.querySelectorAll(".strip-name").forEach((el) => {
          if (!el.hasAttribute("data-en")) {
            el.setAttribute("data-en", el.textContent.trim());
          }
        });
        if (currentLang !== "en") applyDynamic();
      }).observe(strip, { childList: true });
    }

    // Countdown prayer name — updated by script.js every time prayer switches
    const cdName = document.getElementById("cd-prayer-name");
    if (cdName) {
      new MutationObserver(() => {
        const text = cdName.textContent.trim();
        // Only tag if it's a known prayer name (not "Loading…" etc.)
        if (TRANSLATIONS["en"][text]) {
          cdName.setAttribute("data-en", text);
          if (currentLang !== "en") {
            cdName.textContent = translatePrayer(text);
          }
        }
      }).observe(cdName, {
        childList: true,
        characterData: true,
        subtree: true,
      });
    }
  }

  /* ── Build Language Toggle UI ─────────────────────────────── */
  function buildToggle() {
    const wrap = document.createElement("div");
    wrap.className = "lang-toggle";
    wrap.setAttribute("role", "group");
    wrap.setAttribute("aria-label", "Language / ഭാഷ");

    ["EN", "ML"].forEach((label) => {
      const lang = label.toLowerCase();
      const btn = document.createElement("button");
      btn.className = "lang-btn" + (lang === currentLang ? " active" : "");
      btn.textContent = label;
      btn.setAttribute("data-lang", lang);
      btn.setAttribute("aria-pressed", lang === currentLang ? "true" : "false");
      btn.addEventListener("click", () => {
        applyLanguage(lang);
        wrap.querySelectorAll(".lang-btn").forEach((b) => {
          const isActive = b.getAttribute("data-lang") === lang;
          b.classList.toggle("active", isActive);
          b.setAttribute("aria-pressed", isActive ? "true" : "false");
        });
      });
      wrap.appendChild(btn);
    });

    return wrap;
  }

  /* ── Init ─────────────────────────────────────────────────── */
  function init() {
    // Insert toggle into navbar — before the hamburger button
    const hamburger = document.getElementById("hamburger");
    const navContainer = document.querySelector(".nav-container");
    if (navContainer && hamburger) {
      navContainer.insertBefore(buildToggle(), hamburger);
    } else if (navContainer) {
      navContainer.appendChild(buildToggle());
    }

    // Start observing dynamic sections
    setupObservers();

    // Restore saved language preference
    let saved = "en";
    try {
      saved = localStorage.getItem("thaqva-lang") || "en";
    } catch (e) {}
    if (saved !== "en") applyLanguage(saved);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();
